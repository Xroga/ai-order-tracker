{% comment %}
  CourierDetect Widget - Auto Install
  Version: 1.0
  DO NOT EDIT - Auto-managed by CourierDetect App
{% endcomment %}

{{ 'widget-tracking.css' | asset_url | stylesheet_tag }}

<div id="courierdetect-widget" class="courierdetect-widget" data-shop="{{ shop.permanent_domain }}">
  <div class="cd-widget-container">
    <div class="cd-widget-header">
      <div class="cd-widget-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 2L4 5V11C4 16.55 7.84 21.74 12 23C16.16 21.74 20 16.55 20 11V5L12 2Z" fill="currentColor"/>
          <path d="M12 12L16 8H8L12 12Z" fill="white"/>
        </svg>
      </div>
      <h3 class="cd-widget-title">Track Your Order</h3>
      <p class="cd-widget-subtitle">Enter tracking number to check your package status</p>
    </div>
    
    <div class="cd-widget-body">
      <div class="cd-input-group">
        <input type="text" 
               class="cd-tracking-input" 
               placeholder="Enter tracking number (e.g., 1Z999AA1234567890)"
               aria-label="Tracking number">
        <button type="button" class="cd-track-button">
          <span class="cd-button-text">Track</span>
          <span class="cd-button-loader" style="display: none;">
            <svg width="16" height="16" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.3"/>
              <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" fill="none" 
                    stroke-linecap="round" style="transform-origin: center; animation: spin 1s linear infinite;"/>
            </svg>
          </span>
        </button>
      </div>
      
      <div class="cd-result-container" style="display: none;">
        <div class="cd-result-card">
          <div class="cd-result-header">
            <div class="cd-carrier-icon"></div>
            <div class="cd-carrier-info">
              <h4 class="cd-carrier-name"></h4>
              <span class="cd-confidence-badge"></span>
            </div>
          </div>
          
          <div class="cd-tracking-display">
            <code class="cd-tracking-number"></code>
            <button type="button" class="cd-copy-button">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                <rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2"/>
                <path d="M5 15H4C2.89543 15 2 14.1046 2 13V4C2 2.89543 2.89543 2 4 2H13C14.1046 2 15 2.89543 15 4V5" stroke="currentColor" stroke-width="2"/>
              </svg>
              Copy
            </button>
          </div>
          
          <div class="cd-action-buttons">
            <a href="#" target="_blank" class="cd-open-button">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                <path d="M18 13V19C18 20.1046 17.1046 21 16 21H5C3.89543 21 3 20.1046 3 19V8C3 6.89543 3.89543 6 5 6H11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M15 3H21V9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M10 14L21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Open Tracking
            </a>
          </div>
        </div>
        
        <div class="cd-emergency-options" style="display: none;">
          <p class="cd-emergency-title">Alternative Tracking Options:</p>
          <div class="cd-emergency-grid"></div>
        </div>
      </div>
    </div>
    
    <div class="cd-widget-footer">
      <span class="cd-watermark">Powered by CourierDetect</span>
    </div>
  </div>
  
  <button class="cd-widget-toggle" aria-label="Toggle tracking widget">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
</div>

<style>
  /* Widget Container */
  .courierdetect-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    transform: translateY(100px);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  
  .courierdetect-widget.active {
    transform: translateY(0);
    opacity: 1;
  }
  
  /* Widget Box */
  .cd-widget-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    border: 1px solid #e1e5e9;
    width: 380px;
    max-width: 90vw;
    overflow: hidden;
  }
  
  /* Header */
  .cd-widget-header {
    background: linear-gradient(135deg, #5c6ac4 0%, #9c6ade 100%);
    color: white;
    padding: 20px;
    text-align: center;
  }
  
  .cd-widget-icon {
    width: 48px;
    height: 48px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
  }
  
  .cd-widget-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 8px;
  }
  
  .cd-widget-subtitle {
    font-size: 14px;
    opacity: 0.9;
    margin: 0;
  }
  
  /* Body */
  .cd-widget-body {
    padding: 20px;
  }
  
  .cd-input-group {
    display: flex;
    gap: 8px;
  }
  
  .cd-tracking-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s;
  }
  
  .cd-tracking-input:focus {
    outline: none;
    border-color: #5c6ac4;
  }
  
  .cd-track-button {
    background: #5c6ac4;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0 24px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    min-width: 80px;
    transition: background 0.2s;
  }
  
  .cd-track-button:hover {
    background: #4a59b8;
  }
  
  .cd-track-button.loading .cd-button-text {
    display: none;
  }
  
  .cd-track-button.loading .cd-button-loader {
    display: block !important;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* Results */
  .cd-result-container {
    margin-top: 20px;
  }
  
  .cd-result-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    border: 1px solid #e1e5e9;
  }
  
  .cd-result-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .cd-carrier-icon {
    width: 40px;
    height: 40px;
    background: #5c6ac4;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }
  
  .cd-carrier-name {
    font-size: 16px;
    font-weight: 600;
    margin: 0 0 4px;
  }
  
  .cd-confidence-badge {
    background: #10b981;
    color: white;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
  }
  
  .cd-tracking-display {
    background: white;
    border-radius: 6px;
    padding: 10px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    border: 1px solid #e1e5e9;
  }
  
  .cd-tracking-number {
    font-family: 'SF Mono', Monaco, Consolas, monospace;
    font-size: 13px;
    color: #2d3748;
  }
  
  .cd-copy-button {
    background: transparent;
    border: 1px solid #cbd5e0;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 12px;
    color: #4a5568;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
  }
  
  .cd-copy-button:hover {
    background: #f7fafc;
    border-color: #a0aec0;
  }
  
  .cd-action-buttons {
    display: flex;
    gap: 8px;
  }
  
  .cd-open-button {
    flex: 1;
    background: #5c6ac4;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 13px;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: background 0.2s;
  }
  
  .cd-open-button:hover {
    background: #4a59b8;
  }
  
  /* Emergency Options */
  .cd-emergency-options {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px dashed #cbd5e0;
  }
  
  .cd-emergency-title {
    font-size: 13px;
    color: #718096;
    margin: 0 0 12px;
    font-weight: 500;
  }
  
  .cd-emergency-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  
  .cd-emergency-option {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: transform 0.2s;
    text-decoration: none;
    color: inherit;
  }
  
  .cd-emergency-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  
  /* Footer */
  .cd-widget-footer {
    padding: 12px 20px;
    border-top: 1px solid #e1e5e9;
    text-align: center;
  }
  
  .cd-watermark {
    font-size: 12px;
    color: #94a3b8;
  }
  
  /* Toggle Button */
  .cd-widget-toggle {
    position: absolute;
    top: -40px;
    right: 0;
    background: #5c6ac4;
    color: white;
    border: none;
    border-radius: 8px 8px 0 0;
    padding: 10px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Responsive */
  @media (max-width: 480px) {
    .courierdetect-widget {
      bottom: 10px;
      right: 10px;
    }
    
    .cd-widget-container {
      width: calc(100vw - 20px);
    }
    
    .cd-emergency-grid {
      grid-template-columns: 1fr;
    }
  }
  
  /* Animation */
  @keyframes slideIn {
    from {
      transform: translateY(100px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
</style>

<script>
(function() {
  'use strict';
  
  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWidget);
  } else {
    initWidget();
  }
  
  function initWidget() {
    const widget = document.getElementById('courierdetect-widget');
    if (!widget) return;
    
    // Activate widget with animation
    setTimeout(() => {
      widget.classList.add('active');
    }, 1000);
    
    // Setup event listeners
    setupEventListeners(widget);
    
    // Load settings
    loadWidgetSettings(widget);
  }
  
  function setupEventListeners(widget) {
    // Track button
    const trackBtn = widget.querySelector('.cd-track-button');
    const input = widget.querySelector('.cd-tracking-input');
    
    trackBtn.addEventListener('click', () => handleTracking(input.value, widget));
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleTracking(input.value, widget);
    });
    
    // Copy button
    widget.querySelector('.cd-copy-button')?.addEventListener('click', copyTrackingNumber);
    
    // Toggle widget
    widget.querySelector('.cd-widget-toggle')?.addEventListener('click', () => {
      widget.classList.toggle('active');
    });
  }
  
  function loadWidgetSettings(widget) {
    // Load settings from your app's API
    const shop = widget.dataset.shop;
    
    // You can fetch settings from your server here:
    // fetch(`https://yourapp.com/api/widget-settings?shop=${shop}`)
    //   .then(response => response.json())
    //   .then(settings => applySettings(settings));
    
    // For now, use localStorage or default settings
    const settings = JSON.parse(localStorage.getItem('courierdetect_settings') || '{}');
    applySettings(settings);
  }
  
  function applySettings(settings) {
    const widget = document.getElementById('courierdetect-widget');
    if (!widget) return;
    
    if (settings.title) {
      widget.querySelector('.cd-widget-title').textContent = settings.title;
    }
    
    if (settings.subtitle) {
      widget.querySelector('.cd-widget-subtitle').textContent = settings.subtitle;
    }
    
    if (settings.color) {
      document.documentElement.style.setProperty('--primary-color', settings.color);
    }
  }
  
  async function handleTracking(trackingNumber, widget) {
    if (!trackingNumber.trim()) {
      showError('Please enter a tracking number', widget);
      return;
    }
    
    const trackBtn = widget.querySelector('.cd-track-button');
    const resultContainer = widget.querySelector('.cd-result-container');
    
    // Show loading
    trackBtn.classList.add('loading');
    
    try {
      // Use your carrier detection API
      const response = await detectCarrier(trackingNumber);
      
      if (response.success) {
        displayResult(response.data, widget);
        resultContainer.style.display = 'block';
      } else {
        showError('Could not identify carrier', widget);
        showEmergencyOptions(trackingNumber, widget);
      }
    } catch (error) {
      console.error('Tracking error:', error);
      showError('Tracking service unavailable', widget);
    } finally {
      trackBtn.classList.remove('loading');
    }
  }
  
  async function detectCarrier(trackingNumber) {
    // This should call YOUR backend API
    // For demo purposes, we'll use a simple detection
    
    const carriers = {
      'UPS': /^1Z[A-Z0-9]{16}$/,
      'FedEx': /^[0-9]{12}$/,
      'DHL': /^420\d{13}$/,
      'USPS': /^(94|92|93)\d{20}$/
    };
    
    const cleaned = trackingNumber.replace(/\s/g, '').toUpperCase();
    
    for (const [carrier, pattern] of Object.entries(carriers)) {
      if (pattern.test(cleaned)) {
        return {
          success: true,
          data: {
            carrier: carrier,
            trackingNumber: cleaned,
            confidence: '95%',
            trackingUrl: getTrackingUrl(carrier, cleaned)
          }
        };
      }
    }
    
    return { success: false };
  }
  
  function getTrackingUrl(carrier, trackingNumber) {
    const urls = {
      'UPS': `https://www.ups.com/track?tracknum=${trackingNumber}`,
      'FedEx': `https://www.fedex.com/fedextrack/?tracknumbers=${trackingNumber}`,
      'DHL': `https://www.dhl.com/tracking?tracking-id=${trackingNumber}`,
      'USPS': `https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${trackingNumber}`
    };
    
    return urls[carrier] || `https://parcelsapp.com/en/tracking/${trackingNumber}`;
  }
  
  function displayResult(result, widget) {
    const carrierIcon = widget.querySelector('.cd-carrier-icon');
    const carrierName = widget.querySelector('.cd-carrier-name');
    const confidenceBadge = widget.querySelector('.cd-confidence-badge');
    const trackingNumber = widget.querySelector('.cd-tracking-number');
    const openButton = widget.querySelector('.cd-open-button');
    
    // Set carrier-specific icon color
    const colors = {
      'UPS': '#FFB600',
      'FedEx': '#4D148C',
      'DHL': '#FFCC00',
      'USPS': '#333366'
    };
    
    carrierIcon.style.background = colors[result.carrier] || '#5c6ac4';
    carrierName.textContent = result.carrier;
    confidenceBadge.textContent = `${result.confidence} Confidence`;
    trackingNumber.textContent = result.trackingNumber;
    openButton.href = result.trackingUrl;
  }
  
  function showError(message, widget) {
    // Simple error display - enhance as needed
    alert(message);
  }
  
  function showEmergencyOptions(trackingNumber, widget) {
    const container = widget.querySelector('.cd-emergency-grid');
    const emergencySection = widget.querySelector('.cd-emergency-options');
    
    if (!container) return;
    
    const options = [
      { name: 'ParcelsApp', url: `https://parcelsapp.com/en/tracking/${trackingNumber}`, color: '#007bff' },
      { name: '17Track', url: `https://www.17track.net/en/track?nums=${trackingNumber}`, color: '#dc3545' },
      { name: 'AfterShip', url: `https://www.aftership.com/track/${trackingNumber}`, color: '#28a745' },
      { name: 'OrderTracker', url: `https://www.ordertracker.com/track/${trackingNumber}`, color: '#6f42c1' }
    ];
    
    container.innerHTML = options.map(option => `
      <a href="${option.url}" target="_blank" class="cd-emergency-option">
        <span style="color: ${option.color}">‚óè</span>
        <span style="font-size: 13px; font-weight: 500;">${option.name}</span>
      </a>
    `).join('');
    
    emergencySection.style.display = 'block';
  }
  
  function copyTrackingNumber() {
    const trackingNumber = document.querySelector('.cd-tracking-number')?.textContent;
    if (!trackingNumber) return;
    
    navigator.clipboard.writeText(trackingNumber).then(() => {
      const btn = document.querySelector('.cd-copy-button');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Copied!';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    });
  }
})();
</script>
{% comment %}
  Installation Guide for Merchants
  Shows in your app's admin section
{% endcomment %}

<div class="installation-guide">
  <h2>üì¶ Install AI Order Tracker Widget</h2>
  
  <div class="install-steps">
    <div class="step">
      <div class="step-number">1</div>
      <h3>Choose Widget Style</h3>
      <p>Select how you want the widget to appear:</p>
      
      <div class="widget-options">
        <div class="widget-option">
          <h4>Floating Widget</h4>
          <p>Appears in corner of your store</p>
          <pre><code>{% raw %}{% render 'ai-order-tracker-widget', 
  style: 'floating',
  position: 'bottom-right',
  title: 'Track Your Order',
  color: '#5c6ac4'
%}{% endraw %}</code></pre>
        </div>
        
        <div class="widget-option">
          <h4>Inline Widget</h4>
          <p>Embedded in your pages</p>
          <pre><code>{% raw %}{% render 'ai-order-tracker-widget', 
  style: 'inline',
  title: 'Track Package',
  color: '#ff0000'
%}{% endraw %}</code></pre>
        </div>
        
        <div class="widget-option">
          <h4>Simple Widget</h4>
          <p>Minimal one-line tracker</p>
          <pre><code>{% raw %}{% render 'ai-order-tracker-widget', 
  style: 'simple'
%}{% endraw %}</code></pre>
        </div>
      </div>
    </div>
    
    <div class="step">
      <div class="step-number">2</div>
      <h3>Add to Your Theme</h3>
      <p>Add this short code to any Liquid file:</p>
      
      <div class="code-examples">
        <h4>In Product Pages (product.liquid):</h4>
        <pre><code>{% raw %}<div class="product-tracking">
  {% render 'ai-order-tracker-widget', style: 'inline' %}
</div>{% endraw %}</code></pre>
        
        <h4>In Footer (footer.liquid):</h4>
        <pre><code>{% raw %}<footer>
  <!-- Your footer content -->
  {% render 'ai-order-tracker-widget', style: 'floating', position: 'bottom-left' %}
</footer>{% endraw %}</code></pre>
        
        <h4>On Custom Page (page.liquid):</h4>
        <pre><code>{% raw %}<div class="tracking-page">
  <h1>Track Your Package</h1>
  {% render 'ai-order-tracker-widget', style: 'inline' %}
</div>{% endraw %}</code></pre>
      </div>
    </div>
    
    <div class="step">
      <div class="step-number">3</div>
      <h3>Customize (Optional)</h3>
      <p>Adjust the widget to match your store:</p>
      
      <table class="settings-table">
        <tr>
          <th>Parameter</th>
          <th>Description</th>
          <th>Example</th>
        </tr>
        <tr>
          <td><code>title</code></td>
          <td>Widget title text</td>
          <td><code>title: 'Track Package'</code></td>
        </tr>
        <tr>
          <td><code>color</code></td>
          <td>Primary color (hex)</td>
          <td><code>color: '#ff0000'</code></td>
        </tr>
        <tr>
          <td><code>position</code></td>
          <td>Corner position</td>
          <td><code>position: 'top-left'</code></td>
        </tr>
        <tr>
          <td><code>autoopen</code></td>
          <td>Auto open widget</td>
          <td><code>autoopen: true</code></td>
        </tr>
      </table>
    </div>
    
    <div class="step">
      <div class="step-number">4</div>
      <h3>Test & Done!</h3>
      <p>Visit your store to see the widget in action. It works immediately!</p>
      
      <div class="success-message">
        <h4>üéâ Installation Complete!</h4>
        <p>Your customers can now track orders directly on your store.</p>
        <a href="https://{{ shop.domain }}" target="_blank" class="btn btn-primary">
          View Your Store
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  .installation-guide {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 20px;
  }
  
  .install-steps {
    margin-top: 40px;
  }
  
  .step {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid #e1e5e9;
    position: relative;
  }
  
  .step-number {
    position: absolute;
    top: -15px;
    left: -15px;
    width: 40px;
    height: 40px;
    background: #5c6ac4;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 20px;
  }
  
  .widget-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .widget-option {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
  }
  
  pre {
    background: #1a1a1a;
    color: #f8f8f2;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 10px 0;
  }
  
  code {
    font-family: 'SF Mono', Monaco, Consolas, monospace;
  }
  
  .settings-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  
  .settings-table th,
  .settings-table td {
    padding: 12px;
    border: 1px solid #e1e5e9;
    text-align: left;
  }
  
  .success-message {
    background: #d1fae5;
    border: 1px solid #10b981;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
  }
  
  .btn {
    display: inline-block;
    background: #5c6ac4;
    color: white;
    padding: 12px 24px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    margin-top: 10px;
  }
</style>
